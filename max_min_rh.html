<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Observed Temperature & Rainfall</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
      body {
        font-family: "Arial", sans-serif;
        background-color: #f4f7f6;
        padding: 20px;
        margin: 0;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }
      h2 {
        text-align: center;
        color: #2c3e50;
        margin-bottom: 10px;
      }
      .input-section {
        margin-bottom: 30px;
        text-align: center;
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #e9ecef;
      }
      .input-section p {
        margin-top: 0;
        font-weight: bold;
        color: #555;
      }
      button {
        padding: 12px 30px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        transition: background 0.3s;
      }
      button:hover {
        background-color: #0056b3;
      }

      /* Table Styles */
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        font-size: 14px;
        border: 2px solid #000;
        background: white;
      }
      th,
      td {
        border: 1px solid #000;
        padding: 8px 10px;
        text-align: center;
        vertical-align: middle;
      }

      /* Header Styling */
      thead tr:first-child th {
        background-color: #e6b07d;
        font-size: 18px;
        padding: 12px;
        color: #000;
        text-transform: uppercase;
      }
      thead tr:nth-child(2) th {
        background-color: #e6b07d;
        font-weight: bold;
        color: #000;
      }

      /* Column Background Colors */
      /* District (1) & Station (2) */
      tbody td:nth-child(1),
      tbody td:nth-child(2) {
        background-color: #cfd8b6;
        text-align: left;
        font-weight: bold;
        color: #000;
      }

      /* Max Temp (3) */
      tbody td:nth-child(3) {
        background-color: #ffff00;
      }

      /* Min Temp (4) */
      tbody td:nth-child(4) {
        background-color: #dfe8c6;
      }

      /* RH (5) */
      tbody td:nth-child(5) {
        background-color: #9fd0df;
      }

      /* Rain (6) */
      tbody td:nth-child(6) {
        background-color: #00b050;
        font-weight: bold;
      }

      /* Conditional Text Styles */
      .text-red-bold {
        color: red !important;
        font-weight: 900 !important;
      }
      .text-blue-bold {
        color: blue !important;
        font-weight: 900 !important;
      }
      .text-darkblue {
        color: darkblue !important;
        font-weight: 900 !important;
      }
      .text-red {
        color: red !important;
        font-weight: 900 !important;
      }
      .text-na {
        color: black !important;
        font-weight: normal !important;
      }
      .highest-max {
        color: red !important;
        font-weight: 900 !important;
      }
      .lowest-min {
        color: blue !important;
        font-weight: 900 !important;
      }
      /* Input Grid Styles */
      .input-grid {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 15px;
        background: #fff;
        font-size: 13px;
      }
      .input-grid th {
        background: #e9ecef;
        padding: 8px;
        border: 1px solid #ccc;
        text-align: center;
      }
      .input-grid td {
        border: 1px solid #ccc;
        padding: 0;
      }
      .cell-input {
        width: 100%;
        padding: 8px;
        border: none;
        outline: none;
        min-height: 20px;
        display: block;
        cursor: text;
      }
      .sticky-header {
        position: sticky;
        top: 0;
        background: white;
        z-index: 1000;
        padding: 10px 0 5px 0;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      /* Toolbar Styles */
      .toggle-btn {
        text-decoration: none;
        color: #fff;
        background-color: #6c757d;
        padding: 8px 15px;
        border-radius: 5px;
        font-weight: bold;
        transition: background 0.3s;
        display: flex;
        align-items: center;
        gap: 8px;
        border: none;
        cursor: pointer;
        font-size: 14px;
      }
      .toggle-btn:hover {
        background-color: #5a6268;
      }
      .toggle-btn.active {
        background-color: #0056b3;
      }
      .export-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        justify-content: flex-end;
      }
      .btn-secondary {
        background: #6c757d;
        color: white;
        padding: 8px 15px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
      }
      .btn-secondary:hover {
        background: #5a6268;
      }
      /* Button Blink Animation */
      .btn-blink-anim {
        animation: blink-pulse 2s infinite;
        background-color: #ff9800 !important;
        color: white !important;
      }

      @keyframes blink-pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(255, 152, 0, 0.7);
          transform: scale(1);
        }
        50% {
          box-shadow: 0 0 0 10px rgba(255, 152, 0, 0);
          transform: scale(1.05);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(255, 152, 0, 0);
          transform: scale(1);
        }
      }
      /* Selected Button Glow Animation */
      .btn-selected {
        position: relative;
        z-index: 1;
      }
      .btn-selected::before {
        content: "";
        position: absolute;
        top: -6px;
        left: -6px;
        right: -6px;
        bottom: -6px;
        background: linear-gradient(
          45deg,
          #ff0000,
          #ff7300,
          #fffb00,
          #48ff00,
          #00ffd5,
          #002bff,
          #7a00ff,
          #ff00c8,
          #ff0000
        );
        background-size: 400%;
        z-index: -1;
        filter: blur(8px);
        border-radius: 10px;
        animation: glowing 20s linear infinite;
      }
      @keyframes glowing {
        0% {
          background-position: 0 0;
        }
        50% {
          background-position: 400% 0;
        }
        100% {
          background-position: 0 0;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="sticky-header">
        <!-- Navigation Toolbar -->
        <div
          style="
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 10px;
          "
        >
          <a href="index.html" class="toggle-btn btn-blink-anim" title="Home"
            ><i class="fas fa-home"></i
          ></a>
          <a href="live.html" class="toggle-btn" title="Live Preview"
            ><i class="fas fa-tower-broadcast"></i
          ></a>
          <a href="temp.html" class="toggle-btn" title="Live Temp"
            ><i class="fas fa-thermometer-half"></i
          ></a>
          <a href="wind.html" class="toggle-btn" title="Wind"
            ><i class="fas fa-wind"></i
          ></a>
          <a href="rain.html" class="toggle-btn" title="Rain"
            ><i class="fas fa-cloud-showers-heavy"></i
          ></a>
          <a href="humidity.html" class="toggle-btn" title="Humidity"
            ><i class="fas fa-tint"></i
          ></a>
          <a href="display.html" class="toggle-btn" title="Display Mode"
            ><i class="fas fa-tv"></i
          ></a>
          <div style="width: 1px; background: #ccc; margin: 0 5px"></div>
          <a
            href="bulletin.html"
            class="toggle-btn btn-blink-anim"
            title="Weather Bulletin"
            ><i class="fas fa-clipboard-list"></i
          ></a>
          <a
            href="Generate_Weather_Bulletin.html"
            class="toggle-btn"
            title="Generate_Weather_Bulletin"
            ><i class="fas fa-file-lines"></i
          ></a>
          <a
            href="max_min_rh.html"
            class="toggle-btn active"
            style="background-color: #0056b3"
            title="Observed Data"
            ><i class="fas fa-table"></i
          ></a>
          <a
            href="Weather_summary.html"
            class="toggle-btn"
            title="Weather Summary"
            ><i class="fas fa-file-alt"></i
          ></a>
          <a
            href="Detailed_Weather_Forecast.html"
            class="toggle-btn"
            title="Detailed Forecast"
            ><i class="fas fa-list-alt"></i
          ></a>
          <a
            href="Weather_Warning_Table.html"
            class="toggle-btn"
            title="Warning Table"
            ><i class="fas fa-table"></i
          ></a>
          <a href="bulk_import.html" class="toggle-btn" title="Import Data"
            ><i class="fas fa-file-import"></i
          ></a>
          <a
            href="Temperature_Forecast.html"
            class="toggle-btn"
            title="Min/Max Temp"
            ><i class="fas fa-temperature-high"></i
          ></a>
          <a href="forecast.html" class="toggle-btn" title="7-Day Forecast"
            ><i class="fas fa-calendar-day"></i
          ></a>
          <a href="warning.html" class="toggle-btn" title="7-Day Warning"
            ><i class="fas fa-exclamation-triangle"></i
          ></a>
          <a
            href="bulletin_footer.html"
            class="toggle-btn"
            title="Bulletin Footer"
            ><i class="fas fa-file-signature"></i
          ></a>
        </div>

        <h2>Observed Temperature & Rainfall Table Generator</h2>
      </div>

      <div class="input-section">
        <div
          style="
            margin-bottom: 15px;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 10px;
          "
        >
          <label for="reportDate" style="font-weight: bold">Report Date:</label>
          <input
            type="date"
            id="reportDate"
            style="padding: 5px; border: 1px solid #ccc; border-radius: 4px"
          />
        </div>

        <p>
          Paste Data from Excel (District | Station | Max | Min | RH | Rain)
        </p>

        <table class="input-grid" id="inputTable">
          <thead>
            <tr>
              <th>DISTRICT</th>
              <th>STATION</th>
              <th>MAX</th>
              <th>MIN</th>
              <th>RH</th>
              <th>RAIN</th>
            </tr>
          </thead>
          <tbody id="inputBody"></tbody>
        </table>
        <button
          onclick="addInputRows(5)"
          style="
            margin-bottom: 15px;
            padding: 5px 15px;
            font-size: 12px;
            background: #6c757d;
          "
        >
          + Add Rows
        </button>
        <br />
        <button id="generateBtn">Generate Table</button>
        <button
          id="generateBulletinBtn"
          style="margin-left: 10px; background-color: #28a745"
        >
          Table for Bulletin
        </button>
      </div>

      <div class="export-controls" id="exportControls" style="display: none">
        <button class="btn-secondary" onclick="exportToImage()">
          <i class="fas fa-image"></i> Image
        </button>
        <button class="btn-secondary" onclick="exportToPDF()">
          <i class="fas fa-file-pdf"></i> PDF
        </button>
        <button class="btn-secondary" onclick="exportToWord()">
          <i class="fas fa-file-word"></i> Word
        </button>
        <button class="btn-secondary" onclick="exportToExcel()">
          <i class="fas fa-file-excel"></i> Excel
        </button>
      </div>

      <div id="tableContainer"></div>
    </div>

    <script>
      // Initialize immediately if ready, otherwise wait
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initPage);
      } else {
        initPage();
      }

      function initPage() {
        // Set default date to today
        const dateInput = document.getElementById("reportDate");
        if (dateInput) dateInput.valueAsDate = new Date();

        addInputRows(40); // Start with 40 rows
        setupPasteListener();
      }

      document.getElementById("generateBtn").addEventListener("click", () => {
        updateButtonSelection("generateBtn");
        generateTable(false);
      });

      document
        .getElementById("generateBulletinBtn")
        .addEventListener("click", () => {
          updateButtonSelection("generateBulletinBtn");
          generateTable(true);
        });

      function addInputRows(count) {
        const tbody = document.getElementById("inputBody");
        if (!tbody) return;
        for (let i = 0; i < count; i++) {
          const tr = document.createElement("tr");
          for (let j = 0; j < 6; j++) {
            const td = document.createElement("td");
            const div = document.createElement("div");
            div.contentEditable = "true";
            div.className = "cell-input";
            td.appendChild(div);
            tr.appendChild(td);
          }
          tbody.appendChild(tr);
        }
      }

      function setupPasteListener() {
        document.getElementById("inputTable").addEventListener("paste", (e) => {
          e.preventDefault();
          const text = (e.clipboardData || window.clipboardData).getData(
            "text",
          );
          const rows = text.split(/\r\n|\n|\r/);

          let startCell = e.target.closest(".cell-input");
          if (!startCell) return;

          let td = startCell.parentElement;
          let tr = td.parentElement;
          let startRowIdx = Array.from(tr.parentElement.children).indexOf(tr);
          let startColIdx = Array.from(tr.children).indexOf(td);

          const tbody = document.getElementById("inputBody");

          rows.forEach((rowText, rIdx) => {
            if (!rowText.trim()) return;
            const cols = rowText.split("\t");

            let currentRow = tbody.children[startRowIdx + rIdx];
            if (!currentRow) {
              addInputRows(1);
              currentRow = tbody.children[startRowIdx + rIdx];
            }

            cols.forEach((val, cIdx) => {
              const cell = currentRow.children[startColIdx + cIdx];
              if (cell) {
                cell.querySelector(".cell-input").innerText = val.trim();
              }
            });
          });
        });
      }

      function updateButtonSelection(activeId) {
        document.getElementById("generateBtn").classList.remove("btn-selected");
        document
          .getElementById("generateBulletinBtn")
          .classList.remove("btn-selected");
        document.getElementById(activeId).classList.add("btn-selected");
      }

      function generateTable(isBulletin = false) {
        const tbody = document.getElementById("inputBody");
        const rows = Array.from(tbody.children);

        // Date Logic
        const reportDateVal = document.getElementById("reportDate").value;
        if (!reportDateVal) {
          alert("Please select a date.");
          return;
        }

        const dateObj = new Date(reportDateVal);
        const prevDateObj = new Date(dateObj);
        prevDateObj.setDate(dateObj.getDate() - 1);

        const dateStr = formatDateDDMMYYYY(dateObj);
        const prevDateStr = formatDateDDMMYYYY(prevDateObj);

        const parsedData = [];
        const maxVals = [];
        const minVals = [];

        // Step 1: Parse Data & Collect Values
        rows.forEach((tr) => {
          const cells = tr.querySelectorAll(".cell-input");
          const cols = Array.from(cells).map((div) => div.innerText.trim());

          // Skip empty rows
          if (cols.every((c) => c === "")) return;

          if (isBulletin) {
            const isMissing = (v) => !v || v === "" || v.toUpperCase() === "NA";
            if (isMissing(cols[2]) && isMissing(cols[3]) && isMissing(cols[4]))
              return;
          }

          const maxVal = parseFloat(cols[2]);
          const minVal = parseFloat(cols[3]);

          if (!isNaN(maxVal)) maxVals.push(maxVal);
          if (!isNaN(minVal)) minVals.push(minVal);

          parsedData.push({
            district: cols[0],
            station: cols[1],
            max: cols[2],
            min: cols[3],
            rh: cols[4],
            rain: cols[5],
          });
        });

        // Save data for Weather Summary Page
        localStorage.setItem("bihar_observed_data", JSON.stringify(parsedData));
        localStorage.setItem("bihar_observed_report_date", reportDateVal);

        // Step 2: Find Extremes
        const highestMax = maxVals.length ? Math.max(...maxVals) : null;
        const lowestMin = minVals.length ? Math.min(...minVals) : null;

        let html = `
            <table>
                <thead>
                    <tr>
                        <th colspan="6">Observed Temperature & Rainfall – 08:30 IST</th>
                    </tr>
                    <tr>
                        <th>DISTRICT/जिला</th>
                        <th>STATION/स्टेशन</th>
                        <th>Max.Tem/ अधिकतम<br>तापमान(°C) observed on<br>${prevDateStr}</th>
                        <th>Min.Temp/न्यूनतम<br>तापमान(°C) observed on<br>${dateStr}</th>
                        <th>R/H (%) at 08:30 IST /<br>०८:३० पर सापेक्षिक आर्द्रता<br>${dateStr}</th>
                        <th>24 Hrs Rainfall ending at 08:30 IST/<br>०८:३० पर दर्ज़ वर्षा (मिली मीटर)<br>${dateStr}</th>
                    </tr>
                </thead>
                <tbody>
        `;

        parsedData.forEach((d) => {
          html += `<tr>`;

          // Col 1: District
          html += `<td>${d.district || '<span class="text-na">NA</span>'}</td>`;

          // Col 2: Station
          html += `<td>${d.station || '<span class="text-na">NA</span>'}</td>`;

          // Col 3: Max Temp
          const maxNum = parseFloat(d.max);
          let maxClass = "";
          if (!isNaN(maxNum) && highestMax !== null && maxNum === highestMax) {
            maxClass = "highest-max";
          }
          html += `<td>${formatValue(d.max, maxClass)}</td>`;

          // Col 4: Min Temp
          const minNum = parseFloat(d.min);
          let minClass = "";
          if (!isNaN(minNum) && lowestMin !== null && minNum === lowestMin) {
            minClass = "lowest-min";
          }
          html += `<td>${formatValue(d.min, minClass)}</td>`;

          // Col 5: RH
          const rhNum = parseFloat(d.rh);
          let rhClass = "";
          if (!isNaN(rhNum) && rhNum === 100) rhClass = "text-darkblue";
          html += `<td>${formatValue(d.rh, rhClass)}</td>`;

          // Col 6: Rain
          const rainNum = parseFloat(d.rain);
          let rainClass = "";
          if (!isNaN(rainNum) && rainNum > 0) rainClass = "text-red";
          html += `<td>${formatValue(d.rain, rainClass)}</td>`;

          html += `</tr>`;
        });

        html += `<tr>
            <td colspan="6" style="text-align: left; font-size: 11px; border: none !important; padding: 8px; background: white;">*NA- (data not available), (AWS) - Automatic weather station</td>
        </tr>`;

        html += `</tbody></table>`;

        document.getElementById("tableContainer").innerHTML = html;
        document.getElementById("exportControls").style.display = "flex";
      }

      function formatDateDDMMYYYY(d) {
        const day = String(d.getDate()).padStart(2, "0");
        const month = String(d.getMonth() + 1).padStart(2, "0");
        const year = d.getFullYear();
        return `${day}/${month}/${year}`;
      }

      function formatValue(val, className) {
        // Handle Empty or NA
        if (!val || val === "" || val.toUpperCase() === "NA") {
          return '<span class="text-na">NA</span>';
        }
        if (className) {
          return `<span class="${className}">${val}</span>`;
        }
        return val;
      }

      // Export Functions
      function exportToImage() {
        const element = document.getElementById("tableContainer");
        html2canvas(element, { backgroundColor: "#ffffff" }).then((canvas) => {
          const link = document.createElement("a");
          link.download = `Observed_Data_${new Date().toISOString().split("T")[0]}.png`;
          link.href = canvas.toDataURL();
          link.click();
        });
      }

      function exportToPDF() {
        const element = document.getElementById("tableContainer");
        html2canvas(element, { backgroundColor: "#ffffff", scale: 2 }).then(
          (canvas) => {
            const imgData = canvas.toDataURL("image/png");
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF("p", "mm", "a4");
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();

            const imgProps = pdf.getImageProperties(imgData);
            const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;

            let finalHeight = imgHeight;
            let finalWidth = pdfWidth;

            if (imgHeight > pdfHeight) {
              finalHeight = pdfHeight - 20;
              finalWidth = (imgProps.width * finalHeight) / imgProps.height;
            }

            pdf.addImage(imgData, "PNG", 0, 10, finalWidth, finalHeight);
            pdf.save(
              `Observed_Data_${new Date().toISOString().split("T")[0]}.pdf`,
            );
          },
        );
      }

      function exportToWord() {
        const html = document.getElementById("tableContainer").innerHTML;
        const header =
          "<html xmlns:o='urn:schemas-microsoft-com:office:office' " +
          "xmlns:w='urn:schemas-microsoft-com:office:word' " +
          "xmlns='http://www.w3.org/TR/REC-html40'>" +
          "<head><meta charset='utf-8'><title>Export HTML to Word Document with JavaScript<\/title><\/head><body>";
        const footer = "<\/body><\/html>";
        const sourceHTML = header + html + footer;

        const source =
          "data:application/vnd.ms-word;charset=utf-8," +
          encodeURIComponent(sourceHTML);
        const fileDownload = document.createElement("a");
        document.body.appendChild(fileDownload);
        fileDownload.href = source;
        fileDownload.download = `Observed_Data_${new Date().toISOString().split("T")[0]}.doc`;
        fileDownload.click();
        document.body.removeChild(fileDownload);
      }

      function exportToExcel() {
        const table = document.querySelector("#tableContainer table");
        if (!table) return;
        const html = table.outerHTML;
        const blob = new Blob(["\ufeff", html], {
          type: "application/vnd.ms-excel",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `Observed_Data_${new Date().toISOString().split("T")[0]}.xls`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }
    </script>
  </body>
</html>
