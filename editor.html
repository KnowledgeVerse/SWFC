<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ProWord - Advanced Document Editor</title>

    <!-- Bootstrap 5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Open+Sans:wght@400;600&family=Merriweather:wght@300;400;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --page-width: 210mm;
        --page-height: 297mm;
        --page-margin-top: 25mm;
        --page-margin-bottom: 25mm;
        --page-margin-left: 25mm;
        --page-margin-right: 25mm;
        --header-height: 15mm;
        --footer-height: 15mm;
        --editor-bg: #f0f0f0;
        --font-family: "Arial", sans-serif;
      }

      body {
        background-color: var(--editor-bg);
        font-family: "Roboto", sans-serif;
        overflow-x: hidden;
        height: 100vh;
        display: flex;
        flex-direction: column;
      }

      /* --- Toolbar --- */
      .toolbar {
        background: #fff;
        border-bottom: 1px solid #ddd;
        padding: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        z-index: 1000;
        flex-shrink: 0;
      }

      .toolbar-btn {
        background: transparent;
        border: 1px solid transparent;
        border-radius: 4px;
        padding: 5px 10px;
        cursor: pointer;
        color: #444;
        transition: all 0.2s;
      }

      .toolbar-btn:hover {
        background: #f0f0f0;
        border-color: #ccc;
      }

      .toolbar-btn.active {
        background: #e0e0e0;
        border-color: #bbb;
        color: #000;
      }

      .toolbar select {
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 4px;
        font-size: 14px;
      }

      .separator {
        width: 1px;
        height: 24px;
        background: #ddd;
        margin: 0 8px;
        display: inline-block;
        vertical-align: middle;
      }

      /* --- Editor Workspace --- */
      #workspace {
        flex-grow: 1;
        overflow-y: auto;
        padding: 40px 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        background-color: #525659; /* Dark background like Adobe/Word */
      }

      /* --- Page Layout --- */
      .page {
        width: var(--page-width);
        min-height: var(--page-height);
        background: white;
        margin-bottom: 40px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        position: relative;
        display: flex;
        flex-direction: column;
        /* Standard A4 margins */
        padding: var(--page-margin-top) var(--page-margin-right)
          var(--page-margin-bottom) var(--page-margin-left);
        box-sizing: border-box;
        page-break-after: always;
      }

      /* --- Header & Footer Areas --- */
      .page-header,
      .page-footer {
        position: absolute;
        left: var(--page-margin-left);
        right: var(--page-margin-right);
        height: var(--header-height);
        font-size: 11pt;
        color: #666;
        display: flex;
        align-items: center;
      }

      .page-header {
        top: 5mm;
        border-bottom: 1px solid #eee;
      }

      .page-footer {
        bottom: 5mm;
        border-top: 1px solid #eee;
        justify-content: space-between;
      }

      /* --- Content Area --- */
      .page-content {
        flex-grow: 1;
        outline: none;
        font-size: 12pt;
        line-height: 1.6;
        color: #333;
        position: relative;
        z-index: 10;
      }

      /* --- Elements --- */
      .page-content img {
        max-width: 100%;
        cursor: move;
        border: 2px solid transparent;
        display: inline-block;
      }

      .page-content img:hover {
        border: 2px dashed #007bff;
      }

      .page-content img.resizing {
        border: 2px solid #007bff;
      }

      /* Resize handle */
      .resize-handle {
        width: 10px;
        height: 10px;
        background: #007bff;
        position: absolute;
        bottom: -5px;
        right: -5px;
        cursor: se-resize;
        display: none;
        z-index: 20;
      }

      .page-content img.resizing + .resize-handle,
      .page-content img:hover + .resize-handle {
        display: block;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin: 15px 0;
      }
      td,
      th {
        border: 1px solid #ccc;
        padding: 8px;
        min-width: 50px;
      }

      /* --- Print Specifics --- */
      @media print {
        body {
          background: white;
        }
        #workspace {
          padding: 0;
          background: white;
          overflow: visible;
        }
        .page {
          box-shadow: none;
          margin: 0;
          width: 100%;
          height: 100%;
          page-break-after: always;
        }
        .toolbar,
        .btn-add-page {
          display: none !important;
        }
      }

      /* --- ToC Styles --- */
      .toc-entry {
        margin: 5px 0;
        cursor: pointer;
        color: #007bff;
      }
      .toc-entry:hover {
        text-decoration: underline;
      }
      .toc-h1 {
        font-weight: bold;
        margin-left: 0;
      }
      .toc-h2 {
        margin-left: 20px;
      }
      .toc-h3 {
        margin-left: 40px;
        font-size: 0.9em;
      }

      /* --- Bulletin Specific Styles (Imported) --- */
      .header-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 2px solid #000;
        padding-bottom: 15px;
        margin-bottom: 15px;
      }
      .logo-container {
        flex: 0 0 100px;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .logo {
        max-width: 100%;
        height: auto;
        max-height: 90px;
      }
      .header-text {
        flex: 1;
        text-align: center;
        font-weight: bold;
        line-height: 1.4;
        font-size: 14px;
        color: #000;
      }
      .season-title {
        text-align: center;
        font-weight: bold;
        font-size: 16px;
        margin: 15px 0;
        text-decoration: underline;
        text-transform: uppercase;
      }
      .date-time-row {
        display: flex;
        justify-content: space-between;
        font-weight: bold;
        font-size: 14px;
        margin-bottom: 10px;
      }

      /* Tables */
      .forecast-table,
      .imd-table,
      .gen-table,
      .obs-table,
      .table-impact,
      .table-terminology {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
        margin-top: 10px;
        font-family: var(--font-family);
      }
      .forecast-table th,
      .forecast-table td,
      .imd-table th,
      .imd-table td,
      .gen-table th,
      .gen-table td,
      .obs-table th,
      .obs-table td,
      .table-impact th,
      .table-impact td,
      .table-terminology th,
      .table-terminology td {
        border: 1px solid #000;
        padding: 5px;
        text-align: center;
        vertical-align: middle;
      }

      /* Header Colors */
      .forecast-table th,
      .imd-table th {
        background-color: #0056b3;
        color: white;
      }
      .gen-table th {
        background-color: #e0e0e0;
      }
      .table-impact th,
      .table-terminology th {
        background-color: #f0f0f0;
      }
      .obs-table .top-header {
        background-color: #e6b07d;
      }

      /* Background Colors */
      .bg-dry {
        background-color: #ffffff;
        color: #000;
      }
      .bg-isol {
        background-color: #28a745;
        color: #fff;
      }
      .bg-sct {
        background-color: #90ee90;
        color: #000;
      }
      .bg-fws {
        background-color: #007bff;
        color: #fff;
      }
      .bg-ws {
        background-color: #00008b;
        color: #fff;
      }
      .bg-na {
        background-color: #000000;
        color: #fff;
      }

      .warning-green {
        background-color: #28a745 !important;
        color: white;
        font-weight: bold;
      }
      .warning-yellow {
        background-color: #ffc107 !important;
        color: black;
        font-weight: bold;
      }
      .warning-orange {
        background-color: #fd7e14 !important;
        color: white;
        font-weight: bold;
      }
      .warning-red {
        background-color: #dc3545 !important;
        color: white;
        font-weight: bold;
      }

      .row-max-temp td {
        background-color: #fde2e4;
      }
      .row-min-temp td {
        background-color: #e3f2fd;
      }

      .col-impact {
        background-color: #ffff00;
        width: 50%;
      }
      .col-suggestion {
        background-color: #90ee90;
        width: 50%;
      }

      .rain-dry {
        background-color: #fff;
      }
      .rain-isol {
        background-color: #b3d9ff;
      }
      .rain-sct {
        background-color: #80bfff;
      }
      .rain-fws {
        background-color: #4da6ff;
      }
      .rain-ws {
        background-color: #0080ff;
        color: white;
      }

      .warn-green {
        background-color: #90ee90;
      }
      .warn-yellow {
        background-color: #ffff00;
      }
      .warn-orange {
        background-color: #ffa500;
      }
      .warn-red {
        background-color: #ff0000;
        color: white;
      }

      /* Signature Section */
      .signature-section {
        display: flex;
        justify-content: space-between;
        margin-top: 30px;
        padding-top: 20px;
        page-break-inside: avoid;
      }
      .sig-box {
        text-align: center;
        min-width: 200px;
      }
      .sig-line {
        border-bottom: 1px solid #000;
        margin-bottom: 5px;
        height: 30px;
      }
      .sig-label {
        font-weight: bold;
      }

      /* Upload Zone */
      .upload-zone {
        border: 2px dashed #ccc;
        padding: 20px;
        border-radius: 8px;
        background: white;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 120px;
        position: relative;
        margin-bottom: 10px;
      }
      .upload-zone:hover {
        border-color: #667eea;
        background-color: #f8f9fa;
      }
      .upload-zone.success {
        border-color: #28a745;
        background-color: #d4edda;
      }
      .upload-zone i {
        font-size: 2em;
        color: #6c757d;
        margin-bottom: 10px;
      }

      /* Obs Table Specifics */
      .obs-table tbody td:nth-child(1),
      .obs-table tbody td:nth-child(2) {
        background-color: #cfd8b6;
        text-align: left;
        font-weight: bold;
      }
      .obs-table tbody td:nth-child(3) {
        background-color: #ffff00;
        font-weight: bold;
      }
      .obs-table tbody td:nth-child(4) {
        background-color: #dfe8c6;
        font-weight: bold;
      }
      .obs-table tbody td:nth-child(5) {
        background-color: #9fd0df;
        font-weight: bold;
      }
      .obs-table tbody td:nth-child(6) {
        background-color: #00b050;
        font-weight: bold;
      }
      .text-red-bold {
        color: red !important;
        font-weight: 900 !important;
      }
      .text-blue-bold {
        color: blue !important;
        font-weight: 900 !important;
      }
      .text-darkblue {
        color: darkblue !important;
        font-weight: 900 !important;
      }
      .text-red {
        color: red !important;
        font-weight: 900 !important;
      }
      .highest-max {
        color: red !important;
        font-weight: 900 !important;
      }
      .lowest-min {
        color: blue !important;
        font-weight: 900 !important;
      }

      /* Navigation Toolbar */
      .nav-toolbar {
        background: #fff;
        padding: 5px;
        border-bottom: 1px solid #ddd;
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 5px;
        z-index: 1001;
        flex-shrink: 0;
      }
      .toggle-btn {
        text-decoration: none;
        color: #fff;
        background-color: #6c757d;
        padding: 6px 12px;
        border-radius: 5px;
        font-weight: bold;
        transition: background 0.3s;
        display: flex;
        align-items: center;
        gap: 6px;
        border: none;
        cursor: pointer;
        font-size: 13px;
      }
      .toggle-btn:hover {
        background-color: #5a6268;
        color: #fff;
      }
      .toggle-btn.active {
        background-color: #0056b3;
      }
      .btn-blink-anim {
        animation: blink-pulse 2s infinite;
        background-color: #ff9800 !important;
        color: white !important;
      }
      @keyframes blink-pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(255, 152, 0, 0.7);
          transform: scale(1);
        }
        50% {
          box-shadow: 0 0 0 10px rgba(255, 152, 0, 0);
          transform: scale(1.05);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(255, 152, 0, 0);
          transform: scale(1);
        }
      }
    </style>
  </head>
  <body>
    <!-- Navigation Toolbar -->
    <div class="nav-toolbar">
      <a href="index.html" class="toggle-btn btn-blink-anim" title="Home"
        ><i class="fas fa-home"></i
      ></a>
      <a href="live.html" class="toggle-btn" title="Live Preview"
        ><i class="fas fa-tower-broadcast"></i
      ></a>
      <a href="temp.html" class="toggle-btn" title="Live Temp"
        ><i class="fas fa-thermometer-half"></i
      ></a>
      <a href="wind.html" class="toggle-btn" title="Wind"
        ><i class="fas fa-wind"></i
      ></a>
      <a href="rain.html" class="toggle-btn" title="Rain"
        ><i class="fas fa-cloud-showers-heavy"></i
      ></a>
      <a href="humidity.html" class="toggle-btn" title="Humidity"
        ><i class="fas fa-tint"></i
      ></a>
      <a href="display.html" class="toggle-btn" title="Display Mode"
        ><i class="fas fa-tv"></i
      ></a>
      <div style="width: 1px; background: #ccc; margin: 0 5px"></div>
      <a
        href="bulletin.html"
        class="toggle-btn btn-blink-anim"
        title="Weather Bulletin"
        ><i class="fas fa-clipboard-list"></i
      ></a>
      <a
        href="Generate_Weather_Bulletin.html"
        class="toggle-btn"
        title="Generate_Bulletin"
        ><i class="fas fa-file-lines"></i
      ></a>
      <a href="max_min_rh.html" class="toggle-btn" title="Observed Data"
        ><i class="fas fa-table"></i
      ></a>
      <a href="Weather_summary.html" class="toggle-btn" title="Weather Summary"
        ><i class="fas fa-file-alt"></i
      ></a>
      <a
        href="Detailed_Weather_Forecast.html"
        class="toggle-btn"
        title="Detailed Forecast"
        ><i class="fas fa-list-alt"></i
      ></a>
      <a
        href="Weather_Warning_Table.html"
        class="toggle-btn"
        title="Warning Table"
        ><i class="fas fa-table"></i
      ></a>
      <a href="bulk_import.html" class="toggle-btn" title="Import Data"
        ><i class="fas fa-file-import"></i
      ></a>
      <a
        href="Temperature_Forecast.html"
        class="toggle-btn"
        title="Min/Max Temp"
        ><i class="fas fa-temperature-high"></i
      ></a>
      <a href="forecast.html" class="toggle-btn" title="7-Day Forecast"
        ><i class="fas fa-calendar-day"></i
      ></a>
      <a href="warning.html" class="toggle-btn" title="7-Day Warning"
        ><i class="fas fa-exclamation-triangle"></i
      ></a>
      <a href="bulletin_footer.html" class="toggle-btn" title="Bulletin Footer"
        ><i class="fas fa-file-signature"></i
      ></a>
      <a href="editor.html" class="toggle-btn active" title="Editor"
        ><i class="fas fa-edit"></i
      ></a>
    </div>

    <!-- Controls Bar -->
    <div
      class="controls-bar"
      style="
        background: #f8f9fa;
        padding: 10px;
        border-bottom: 1px solid #ddd;
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
        justify-content: center;
        z-index: 1000;
      "
    >
      <div
        class="control-group"
        style="display: flex; align-items: center; gap: 5px"
      >
        <label style="font-weight: bold; font-size: 14px; margin: 0"
          >Date:</label
        >
        <input
          type="date"
          id="manualDateInput"
          onchange="updateManualDate()"
          style="padding: 4px; border: 1px solid #ccc; border-radius: 4px"
        />
      </div>
      <div
        class="control-group"
        style="display: flex; align-items: center; gap: 5px"
      >
        <label style="font-weight: bold; font-size: 14px; margin: 0"
          >Time Mode:</label
        >
        <label style="font-size: 14px; margin: 0"
          ><input
            type="radio"
            name="timeMode"
            value="auto"
            checked
            onchange="toggleTimeMode()"
          />
          Auto</label
        >
        <label style="font-size: 14px; margin: 0"
          ><input
            type="radio"
            name="timeMode"
            value="manual"
            onchange="toggleTimeMode()"
          />
          Manual</label
        >
      </div>
      <div
        class="control-group"
        id="manualTimeContainer"
        style="display: none; align-items: center; gap: 5px"
      >
        <input
          type="time"
          id="manualTimeInput"
          onchange="updateManualTime()"
          style="padding: 4px; border: 1px solid #ccc; border-radius: 4px"
        />
      </div>
      <div
        class="control-group"
        style="display: flex; align-items: center; gap: 5px"
      >
        <label style="font-weight: bold; font-size: 14px; margin: 0"
          >Page Size:</label
        >
        <select
          id="pageSizeSelect"
          onchange="updatePageSize()"
          style="padding: 4px; border: 1px solid #ccc; border-radius: 4px"
        >
          <option value="a4">A4 (210mm x 297mm)</option>
          <option value="legal">Legal (216mm x 356mm)</option>
        </select>
      </div>
      <div class="control-group" style="display: flex; gap: 5px">
        <button class="btn btn-info btn-sm text-white" onclick="saveTemplate()">
          <i class="fas fa-save"></i> Save Template
        </button>
        <button class="btn btn-info btn-sm text-white" onclick="loadTemplate()">
          <i class="fas fa-folder-open"></i> Load Template
        </button>
        <button
          class="btn btn-primary btn-sm text-white"
          onclick="openMarginModal()"
        >
          <i class="fas fa-ruler-combined"></i> Page Margins
        </button>
        <button
          class="btn btn-warning btn-sm text-white"
          onclick="loadBulletinData()"
        >
          <i class="fas fa-magic"></i> Load Bulletin Data
        </button>
        <button
          class="btn btn-secondary btn-sm text-white"
          onclick="toggleUploadPanel()"
        >
          <i class="fas fa-upload"></i> Uploads
        </button>
      </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar d-flex flex-wrap align-items-center gap-2">
      <div class="btn-group">
        <button class="toolbar-btn" onclick="formatDoc('undo')" title="Undo">
          <i class="fas fa-undo"></i>
        </button>
        <button class="toolbar-btn" onclick="formatDoc('redo')" title="Redo">
          <i class="fas fa-redo"></i>
        </button>
      </div>
      <div class="separator"></div>

      <select
        onchange="
          formatDoc('fontName', this.value);
          this.value = '';
        "
      >
        <option value="" selected disabled>Font</option>
        <option value="Arial">Arial</option>
        <option value="Courier New">Courier New</option>
        <option value="Georgia">Georgia</option>
        <option value="Merriweather">Merriweather</option>
        <option value="Roboto">Roboto</option>
        <option value="Times New Roman">Times New Roman</option>
      </select>

      <select
        onchange="
          formatDoc('fontSize', this.value);
          this.value = '';
        "
      >
        <option value="" selected disabled>Size</option>
        <option value="1">Small</option>
        <option value="3">Normal</option>
        <option value="5">Large</option>
        <option value="7">Huge</option>
      </select>

      <div class="separator"></div>

      <button class="toolbar-btn" onclick="formatDoc('bold')">
        <i class="fas fa-bold"></i>
      </button>
      <button class="toolbar-btn" onclick="formatDoc('italic')">
        <i class="fas fa-italic"></i>
      </button>
      <button class="toolbar-btn" onclick="formatDoc('underline')">
        <i class="fas fa-underline"></i>
      </button>
      <button class="toolbar-btn" onclick="formatDoc('strikeThrough')">
        <i class="fas fa-strikethrough"></i>
      </button>

      <div class="separator"></div>

      <input
        type="color"
        class="toolbar-btn"
        style="width: 40px; padding: 2px"
        onchange="formatDoc('foreColor', this.value)"
        title="Text Color"
      />
      <input
        type="color"
        class="toolbar-btn"
        style="width: 40px; padding: 2px"
        onchange="formatDoc('hiliteColor', this.value)"
        title="Highlight Color"
      />

      <div class="separator"></div>

      <button class="toolbar-btn" onclick="formatDoc('justifyLeft')">
        <i class="fas fa-align-left"></i>
      </button>
      <button class="toolbar-btn" onclick="formatDoc('justifyCenter')">
        <i class="fas fa-align-center"></i>
      </button>
      <button class="toolbar-btn" onclick="formatDoc('justifyRight')">
        <i class="fas fa-align-right"></i>
      </button>
      <button class="toolbar-btn" onclick="formatDoc('justifyFull')">
        <i class="fas fa-align-justify"></i>
      </button>

      <div class="separator"></div>

      <button class="toolbar-btn" onclick="formatDoc('insertUnorderedList')">
        <i class="fas fa-list-ul"></i>
      </button>
      <button class="toolbar-btn" onclick="formatDoc('insertOrderedList')">
        <i class="fas fa-list-ol"></i>
      </button>

      <div class="separator"></div>

      <button class="toolbar-btn" onclick="insertTable()">
        <i class="fas fa-table"></i>
      </button>
      <button class="toolbar-btn" onclick="insertImage()">
        <i class="fas fa-image"></i>
      </button>
      <button class="toolbar-btn" onclick="insertLink()">
        <i class="fas fa-link"></i>
      </button>

      <div class="separator"></div>

      <button
        class="toolbar-btn btn-warning text-white"
        onclick="generateTOC()"
      >
        <i class="fas fa-book"></i> ToC
      </button>
      <button
        class="toolbar-btn btn-info text-white"
        onclick="insertSectionBreak()"
      >
        <i class="fas fa-cut"></i> Section
      </button>

      <div class="ms-auto btn-group">
        <button class="btn btn-outline-success btn-sm" onclick="exportImage()">
          <i class="fas fa-image"></i> Image
        </button>
        <button class="btn btn-outline-secondary btn-sm" onclick="exportPDF()">
          <i class="fas fa-file-pdf"></i> PDF
        </button>
        <button class="btn btn-outline-primary btn-sm" onclick="exportDOCX()">
          <i class="fas fa-file-word"></i> DOCX
        </button>
        <button class="btn btn-outline-success btn-sm" onclick="window.print()">
          <i class="fas fa-print"></i> Print
        </button>
      </div>
    </div>

    <!-- Manual Upload Panel (Hidden) -->
    <div
      id="uploadPanel"
      style="
        display: none;
        position: fixed;
        top: 120px;
        left: 50%;
        transform: translateX(-50%);
        width: 80%;
        max-width: 800px;
        background: #f8f9fa;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        z-index: 2000;
        max-height: 80vh;
        overflow-y: auto;
      "
    >
      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 15px;
        "
      >
        <h5 style="margin: 0">Manual Image Upload</h5>
        <button class="btn-close" onclick="toggleUploadPanel()"></button>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px">
        <!-- Auto Detect Zone -->
        <div
          class="upload-zone"
          style="
            grid-column: 1 / -1;
            background: #e3f2fd;
            border-color: #2196f3;
          "
          onclick="document.getElementById('fileAuto').click()"
        >
          <i class="fas fa-magic" style="color: #2196f3"></i>
          <div style="color: #0d47a1">
            <strong>Auto Detect Images (Select Multiple)</strong>
          </div>
          <div style="font-size: 0.8em; color: #555">
            Select all downloaded maps together. Filenames will be
            auto-detected.
          </div>
          <input
            type="file"
            id="fileAuto"
            multiple
            accept="image/*"
            style="display: none"
            onchange="handleAutoUpload(this)"
          />
        </div>

        <!-- Individual Zones -->
        <div
          class="upload-zone"
          onclick="document.getElementById('fileMin').click()"
          id="dropZoneMin"
        >
          <i class="fas fa-temperature-low"></i>
          <div>Min Temp Map</div>
          <input
            type="file"
            id="fileMin"
            accept="image/*"
            style="display: none"
            onchange="handleManualUpload('min', this)"
          />
        </div>
        <div
          class="upload-zone"
          onclick="document.getElementById('fileMax').click()"
          id="dropZoneMax"
        >
          <i class="fas fa-temperature-high"></i>
          <div>Max Temp Map</div>
          <input
            type="file"
            id="fileMax"
            accept="image/*"
            style="display: none"
            onchange="handleManualUpload('max', this)"
          />
        </div>
        <div
          class="upload-zone"
          onclick="document.getElementById('fileForecast').click()"
          id="dropZoneForecast"
        >
          <i class="fas fa-cloud-sun"></i>
          <div>Forecast Map</div>
          <input
            type="file"
            id="fileForecast"
            accept="image/*"
            style="display: none"
            onchange="handleManualUpload('forecast', this)"
          />
        </div>
        <div
          class="upload-zone"
          onclick="document.getElementById('fileWarning').click()"
          id="dropZoneWarning"
        >
          <i class="fas fa-exclamation-triangle"></i>
          <div>Warning Map</div>
          <input
            type="file"
            id="fileWarning"
            accept="image/*"
            style="display: none"
            onchange="handleManualUpload('warning', this)"
          />
        </div>
      </div>
    </div>

    <!-- Margin Setup Modal -->
    <div
      id="marginModal"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2001;
        justify-content: center;
        align-items: center;
      "
    >
      <div
        style="
          background: white;
          padding: 20px;
          border-radius: 8px;
          width: 300px;
          box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        "
      >
        <h5
          style="
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
          "
        >
          Page Margins (mm)
        </h5>
        <div
          style="
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
          "
        >
          <div>
            <label style="font-size: 12px; font-weight: bold">Top</label>
            <input
              type="number"
              id="marginTopInput"
              class="form-control form-control-sm"
              value="25"
            />
          </div>
          <div>
            <label style="font-size: 12px; font-weight: bold">Bottom</label>
            <input
              type="number"
              id="marginBottomInput"
              class="form-control form-control-sm"
              value="25"
            />
          </div>
          <div>
            <label style="font-size: 12px; font-weight: bold">Left</label>
            <input
              type="number"
              id="marginLeftInput"
              class="form-control form-control-sm"
              value="25"
            />
          </div>
          <div>
            <label style="font-size: 12px; font-weight: bold">Right</label>
            <input
              type="number"
              id="marginRightInput"
              class="form-control form-control-sm"
              value="25"
            />
          </div>
        </div>
        <div style="text-align: right">
          <button class="btn btn-secondary btn-sm" onclick="closeMarginModal()">
            Cancel
          </button>
          <button class="btn btn-primary btn-sm" onclick="saveMargins()">
            Save & Apply
          </button>
        </div>
        <div style="margin-top: 10px; font-size: 11px; color: #666">
          * Settings will be saved for future visits.
        </div>
      </div>
    </div>

    <!-- Workspace -->
    <div id="workspace">
      <!-- Pages will be injected here -->
    </div>

    <!-- Hidden file input for images -->
    <input type="file" id="imgUpload" accept="image/*" style="display: none" />

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <script>
      // --- State Management ---
      let pageCount = 0;
      const workspace = document.getElementById("workspace");
      const imgUpload = document.getElementById("imgUpload");
      let autoTimeInterval;

      // --- Initialization ---
      document.addEventListener("DOMContentLoaded", () => {
        loadFromStorage();
        loadMargins(); // Load saved margins
        if (document.querySelectorAll(".page").length === 0) {
          addPage();
        }
        setupAutoSave();
        setupDragAndResize();
        initDateTime();
      });

      // --- Core Editor Functions ---

      function formatDoc(cmd, value = null) {
        document.execCommand(cmd, false, value);
        document.querySelector(".page-content:focus")?.focus();
      }

      function addPage(contentHTML = "") {
        pageCount++;
        const page = document.createElement("div");
        page.className = "page";
        page.id = `page-${pageCount}`;

        // Header
        const header = document.createElement("div");
        header.className = "page-header";
        header.innerHTML = `<span contenteditable="true">Header Section ${pageCount}</span>`;

        // Footer
        const footer = document.createElement("div");
        footer.className = "page-footer";
        footer.innerHTML = `
                <span contenteditable="true">Footer</span>
                <span>Page <span class="page-num">${pageCount}</span> of <span class="total-pages">${pageCount}</span></span>
            `;

        // Content
        const content = document.createElement("div");
        content.className = "page-content";
        content.contentEditable = true;
        content.innerHTML = contentHTML || "<p><br></p>";

        // Event listeners for content
        content.addEventListener("keydown", handleKeyDown);
        content.addEventListener("input", handleInput);
        content.addEventListener("click", handleImageClick);

        page.appendChild(header);
        page.appendChild(content);
        page.appendChild(footer);

        workspace.appendChild(page);
        updatePageNumbers();

        // Focus new page if empty
        if (!contentHTML) content.focus();
      }

      function clearWorkspace() {
        workspace.innerHTML = "";
        pageCount = 0;
      }

      function updatePageNumbers() {
        const pages = document.querySelectorAll(".page");
        pages.forEach((page, index) => {
          page.querySelector(".page-num").textContent = index + 1;
          page.querySelector(".total-pages").textContent = pages.length;
        });
      }

      // --- Input Handling & Auto-Pagination ---

      function handleKeyDown(e) {
        // Check if we need a new page (simple heuristic)
        const content = e.target;
        const page = content.closest(".page");

        // If Enter is pressed and we are near the bottom
        if (e.key === "Enter") {
          // setTimeout to let the DOM update first
          setTimeout(() => {
            if (content.scrollHeight > content.clientHeight) {
              // Logic to move overflow to next page would go here
              // For this frontend demo, we rely on CSS overflow or manual page breaks
              // A true pagination engine requires complex text measurement.
            }
          }, 0);
        }
      }

      function handleInput(e) {
        // Autosave trigger
        window.dispatchEvent(new Event("content-updated"));
      }

      // --- Insert Features ---

      function insertImage() {
        imgUpload.click();
      }

      imgUpload.addEventListener("change", function (e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (event) {
          const img = document.createElement("img");
          img.src = event.target.result;
          img.style.width = "200px"; // Default size
          img.style.height = "auto";

          // Insert at cursor
          const selection = window.getSelection();
          if (selection.rangeCount > 0) {
            const range = selection.getRangeAt(0);
            range.deleteContents();
            range.insertNode(img);

            // Add resize handle logic container
            addResizeHandle(img);
          }
        };
        reader.readAsDataURL(file);
        this.value = ""; // Reset
      });

      function addResizeHandle(img) {
        // Simple logic to make image resizable
        img.addEventListener("mousedown", initDrag);
      }

      function insertTable() {
        const rows = prompt("Rows:", 3);
        const cols = prompt("Columns:", 3);
        if (!rows || !cols) return;

        let html = '<table class="table table-bordered"><tbody>';
        for (let i = 0; i < rows; i++) {
          html += "<tr>";
          for (let j = 0; j < cols; j++) {
            html += "<td>Cell</td>";
          }
          html += "</tr>";
        }
        html += "</tbody></table><p><br></p>";
        formatDoc("insertHTML", html);
      }

      function insertLink() {
        const url = prompt("Enter URL:", "https://");
        if (url) formatDoc("createLink", url);
      }

      function insertSectionBreak() {
        // Adds a new page immediately
        addPage();
        // Scroll to new page
        window.scrollTo(0, document.body.scrollHeight);
      }

      // --- Drag and Resize Logic ---

      function setupDragAndResize() {
        let isResizing = false;
        let currentImage = null;
        let startX, startY, startWidth, startHeight;

        document.addEventListener("mousedown", function (e) {
          if (e.target.tagName === "IMG") {
            currentImage = e.target;
            // Bring to front logic if needed, but images are inline/block
          }

          // Check for resize handle (we will append a handle dynamically or use a corner check)
          // For simplicity in this robust demo, we use a specific class or just drag bottom-right
          if (
            currentImage &&
            e.offsetX > currentImage.width - 10 &&
            e.offsetY > currentImage.height - 10
          ) {
            isResizing = true;
            startX = e.clientX;
            startY = e.clientY;
            startWidth = parseInt(
              document.defaultView.getComputedStyle(currentImage).width,
              10,
            );
            startHeight = parseInt(
              document.defaultView.getComputedStyle(currentImage).height,
              10,
            );
            e.preventDefault();
          }
        });

        document.addEventListener("mousemove", function (e) {
          if (!isResizing || !currentImage) return;
          currentImage.style.width = startWidth + e.clientX - startX + "px";
          currentImage.style.height = startHeight + e.clientY - startY + "px";
        });

        document.addEventListener("mouseup", function () {
          isResizing = false;
          currentImage = null;
        });
      }

      function initDrag(e) {
        // Basic drag implementation could go here
        // Browsers handle image dragging natively, but we might want custom ghost elements
      }

      function handleImageClick(e) {
        if (e.target.tagName === "IMG") {
          // Select image logic
        }
      }

      // --- Table of Contents ---

      function generateTOC() {
        const tocContainer = document.createElement("div");
        tocContainer.className = "toc-container";
        tocContainer.innerHTML = "<h2>Table of Contents</h2>";

        const headings = document.querySelectorAll(
          ".page-content h1, .page-content h2, .page-content h3",
        );

        if (headings.length === 0) {
          alert("No headings (H1, H2, H3) found in document.");
          return;
        }

        headings.forEach((heading, index) => {
          // Assign ID if not exists
          if (!heading.id) heading.id = `heading-${index}`;

          const entry = document.createElement("div");
          entry.className = `toc-entry toc-${heading.tagName.toLowerCase()}`;
          entry.textContent = heading.textContent;
          entry.onclick = () => {
            heading.scrollIntoView({ behavior: "smooth", block: "center" });
            // Visual highlight effect
            heading.style.backgroundColor = "#ffffcc";
            setTimeout(
              () => (heading.style.backgroundColor = "transparent"),
              2000,
            );
          };
          tocContainer.appendChild(entry);
        });

        // Insert ToC at the beginning of the first page
        const firstPageContent = document.querySelector(".page-content");
        firstPageContent.insertBefore(
          tocContainer,
          firstPageContent.firstChild,
        );
      }

      // --- Export Functions ---

      async function exportImage() {
        const pages = document.querySelectorAll(".page");
        const btn = document.querySelector('button[onclick="exportImage()"]');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

        for (let i = 0; i < pages.length; i++) {
          try {
            const canvas = await html2canvas(pages[i], {
              scale: 2,
              useCORS: true,
              logging: false,
            });
            const link = document.createElement("a");
            link.download = `Page_${i + 1}.png`;
            link.href = canvas.toDataURL("image/png");
            link.click();
          } catch (e) {
            console.error(e);
            alert("Error exporting image for page " + (i + 1));
          }
        }
        btn.innerHTML = originalText;
      }

      async function exportPDF() {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF("p", "mm", "a4");
        const pages = document.querySelectorAll(".page");

        // Show loading
        const btn = document.querySelector('button[onclick="exportPDF()"]');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';

        for (let i = 0; i < pages.length; i++) {
          const canvas = await html2canvas(pages[i], {
            scale: 2, // High quality
            useCORS: true,
            logging: false,
          });

          const imgData = canvas.toDataURL("image/png");
          const imgProps = pdf.getImageProperties(imgData);
          const pdfWidth = pdf.internal.pageSize.getWidth();
          const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

          if (i > 0) pdf.addPage();
          pdf.addImage(imgData, "PNG", 0, 0, pdfWidth, pdfHeight);
        }

        pdf.save("document.pdf");
        btn.innerHTML = originalText;
      }

      function exportDOCX() {
        // This is a simplified DOCX generator.
        // A full implementation requires building the XML structure for Word.
        // Here we construct a basic valid DOCX using JSZip.

        const zip = new JSZip();
        const content = getAllContentHTML();

        // Standard DOCX structure
        const docXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
            <w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
                <w:body>
                    ${convertHTMLToWordXML(content)}
                    <w:sectPr>
                        <w:pgSz w:w="12240" w:h="15840"/>
                        <w:pgMar w:top="1440" w:right="1440" w:bottom="1440" w:left="1440" w:header="720" w:footer="720"/>
                    </w:sectPr>
                </w:body>
            </w:document>`;

        zip.file("word/document.xml", docXml);

        // Add required rels and content types (simplified)
        zip.file(
          "[Content_Types].xml",
          `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
            <Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
                <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
                <Default Extension="xml" ContentType="application/xml"/>
                <Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>
            </Types>`,
        );

        zip.file(
          "_rels/.rels",
          `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
            <Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
                <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>
            </Relationships>`,
        );

        zip.generateAsync({ type: "blob" }).then(function (content) {
          saveAs(content, "document.docx");
        });
      }

      function getAllContentHTML() {
        let html = "";
        document.querySelectorAll(".page-content").forEach((page) => {
          html += page.innerHTML;
          html += '<br style="page-break-after: always;" />';
        });
        return html;
      }

      function convertHTMLToWordXML(html) {
        // Very basic converter for demo purposes
        // In a real app, use a library like html-docx-js or mammoth
        let xml = html;

        // Replace basic tags
        xml = xml
          .replace(/<p>/g, "<w:p><w:r><w:t>")
          .replace(/<\/p>/g, "<\/w:t><\/w:r><\/w:p>");
        xml = xml
          .replace(/<b>/g, "<w:rPr><w:b/><\/w:rPr>")
          .replace(/<\/b>/g, "");
        xml = xml
          .replace(/<i>/g, "<w:rPr><w:i/><\/w:rPr>")
          .replace(/<\/i>/g, "");
        xml = xml
          .replace(/<u>/g, '<w:rPr><w:u w:val="single"/><\/w:rPr>')
          .replace(/<\/u>/g, "");

        // Clean up unsupported tags (images, tables will be stripped in this simple version)
        xml = xml.replace(/<img[^>]*>/g, "[IMAGE]");
        xml = xml.replace(/<div[^>]*>/g, "").replace(/<\/div>/g, "");
        xml = xml.replace(/<br\s*\/?>/gi, "<w:br/>");

        return xml;
      }

      // --- Local Storage ---

      function setupAutoSave() {
        let timeout;
        window.addEventListener("content-updated", () => {
          clearTimeout(timeout);
          timeout = setTimeout(saveToStorage, 1000);
        });
      }

      function saveToStorage() {
        const data = [];
        document.querySelectorAll(".page").forEach((page) => {
          data.push({
            header: page.querySelector(".page-header").innerHTML,
            content: page.querySelector(".page-content").innerHTML,
            footer: page.querySelector(".page-footer").innerHTML,
          });
        });
        localStorage.setItem("proword-document", JSON.stringify(data));
        console.log("Document autosaved");
      }

      function loadFromStorage() {
        const data = JSON.parse(localStorage.getItem("proword-document"));
        if (data && data.length > 0) {
          if (confirm("Restore previous document?")) {
            data.forEach((pageData) => {
              addPage(pageData.content);
              const currentPage =
                document.querySelectorAll(".page")[
                  document.querySelectorAll(".page").length - 1
                ];
              currentPage.querySelector(".page-header").innerHTML =
                pageData.header;
              currentPage.querySelector(".page-footer").innerHTML =
                pageData.footer;
            });
          }
        }
      }

      // --- New Controls Logic ---

      function initDateTime() {
        const dateInput = document.getElementById("manualDateInput");
        if (dateInput) {
          dateInput.valueAsDate = new Date();
        }
        toggleTimeMode();
      }

      function updateManualDate() {
        // Logic to update date in document if placeholders exist
        console.log(
          "Date updated:",
          document.getElementById("manualDateInput").value,
        );
      }

      function toggleTimeMode() {
        const mode = document.querySelector(
          'input[name="timeMode"]:checked',
        ).value;
        const manualContainer = document.getElementById("manualTimeContainer");

        if (mode === "manual") {
          manualContainer.style.display = "flex";
          clearInterval(autoTimeInterval);
        } else {
          manualContainer.style.display = "none";
          updateAutoTime();
          autoTimeInterval = setInterval(updateAutoTime, 60000);
        }
      }

      function updateAutoTime() {
        const now = new Date();
        const timeStr = now.toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
        });
        // Logic to update time in document
        // console.log("Auto Time:", timeStr);
      }

      function updateManualTime() {
        const timeStr = document.getElementById("manualTimeInput").value;
        // Logic to update time in document
        console.log("Manual Time:", timeStr);
      }

      function updatePageSize() {
        const size = document.getElementById("pageSizeSelect").value;
        const root = document.documentElement;
        if (size === "legal") {
          root.style.setProperty("--page-width", "216mm");
          root.style.setProperty("--page-height", "356mm");
        } else {
          root.style.setProperty("--page-width", "210mm");
          root.style.setProperty("--page-height", "297mm");
        }
      }

      function saveTemplate() {
        const data = [];
        document.querySelectorAll(".page").forEach((page) => {
          data.push({
            header: page.querySelector(".page-header").innerHTML,
            content: page.querySelector(".page-content").innerHTML,
            footer: page.querySelector(".page-footer").innerHTML,
          });
        });
        localStorage.setItem("proword-template", JSON.stringify(data));
        alert("Template saved successfully!");
      }

      function loadTemplate() {
        const data = JSON.parse(localStorage.getItem("proword-template"));
        if (data && data.length > 0) {
          if (confirm("Load template? This will overwrite current content.")) {
            workspace.innerHTML = ""; // Clear existing
            pageCount = 0;
            data.forEach((pageData) => {
              addPage(pageData.content);
              const currentPage = document.getElementById(`page-${pageCount}`);
              currentPage.querySelector(".page-header").innerHTML =
                pageData.header;
              currentPage.querySelector(".page-footer").innerHTML =
                pageData.footer;
            });
          }
        } else {
          alert("No template found.");
        }
      }

      // --- Margin Logic ---
      function openMarginModal() {
        // Populate inputs with current CSS variable values
        const root = document.documentElement;
        const getVal = (prop) =>
          parseInt(getComputedStyle(root).getPropertyValue(prop)) || 25;

        document.getElementById("marginTopInput").value =
          getVal("--page-margin-top");
        document.getElementById("marginBottomInput").value = getVal(
          "--page-margin-bottom",
        );
        document.getElementById("marginLeftInput").value =
          getVal("--page-margin-left");
        document.getElementById("marginRightInput").value = getVal(
          "--page-margin-right",
        );

        document.getElementById("marginModal").style.display = "flex";
      }

      function closeMarginModal() {
        document.getElementById("marginModal").style.display = "none";
      }

      function saveMargins() {
        const top = document.getElementById("marginTopInput").value;
        const bottom = document.getElementById("marginBottomInput").value;
        const left = document.getElementById("marginLeftInput").value;
        const right = document.getElementById("marginRightInput").value;

        const margins = { top, bottom, left, right };
        localStorage.setItem("bihar_editor_margins", JSON.stringify(margins));
        applyMargins(margins);
        closeMarginModal();
        alert("Margins saved and applied!");
      }

      function loadMargins() {
        const saved = localStorage.getItem("bihar_editor_margins");
        if (saved) {
          try {
            const margins = JSON.parse(saved);
            applyMargins(margins);
          } catch (e) {
            console.error("Error loading margins", e);
          }
        }
      }

      function applyMargins(margins) {
        const root = document.documentElement;
        if (margins.top)
          root.style.setProperty("--page-margin-top", margins.top + "mm");
        if (margins.bottom)
          root.style.setProperty("--page-margin-bottom", margins.bottom + "mm");
        if (margins.left)
          root.style.setProperty("--page-margin-left", margins.left + "mm");
        if (margins.right)
          root.style.setProperty("--page-margin-right", margins.right + "mm");
      }

      // --- Auto Upload Logic ---
      function handleAutoUpload(input) {
        if (!input.files || input.files.length === 0) return;

        const files = Array.from(input.files);
        let count = 0;

        files.forEach((file) => {
          const name = file.name.toLowerCase();
          let type = null;

          if (name.includes("warning")) type = "warning";
          else if (name.includes("maximum")) type = "max";
          else if (name.includes("minimum")) type = "min";
          else if (name.includes("forecast") && !name.includes("temperature"))
            type = "forecast";

          if (type) {
            // Process file
            const reader = new FileReader();
            reader.onload = function (e) {
              const key =
                type === "min"
                  ? "bihar_min_temp_forecast_image"
                  : type === "max"
                    ? "bihar_max_temp_forecast_image"
                    : type === "forecast"
                      ? "bihar_forecast_image"
                      : "bihar_warning_image";
              localStorage.setItem(key, e.target.result);

              // Update UI feedback
              const zoneId =
                type === "min"
                  ? "dropZoneMin"
                  : type === "max"
                    ? "dropZoneMax"
                    : type === "forecast"
                      ? "dropZoneForecast"
                      : "dropZoneWarning";
              const zone = document.getElementById(zoneId);
              if (zone) {
                zone.classList.add("success");
                zone.querySelector("div").innerText += " (Auto)";
              }
            };
            reader.readAsDataURL(file);
            count++;
          }
        });

        if (count > 0) alert(`${count} maps auto-detected and loaded!`);
        else alert("No matching maps found in selection.");
        input.value = ""; // Reset
      }

      // --- Bulletin Generation Logic ---

      function toggleUploadPanel() {
        const panel = document.getElementById("uploadPanel");
        panel.style.display = panel.style.display === "none" ? "block" : "none";
      }

      function handleManualUpload(type, input) {
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const key =
              type === "min"
                ? "bihar_min_temp_forecast_image"
                : type === "max"
                  ? "bihar_max_temp_forecast_image"
                  : type === "forecast"
                    ? "bihar_forecast_image"
                    : "bihar_warning_image";
            localStorage.setItem(key, e.target.result);

            const zone = document.getElementById(
              type === "min"
                ? "dropZoneMin"
                : type === "max"
                  ? "dropZoneMax"
                  : type === "forecast"
                    ? "dropZoneForecast"
                    : "dropZoneWarning",
            );
            zone.classList.add("success");
            zone.querySelector("div").innerText += " (Loaded)";

            alert(
              `${type.toUpperCase()} Map Loaded! Click 'Load Bulletin Data' to refresh.`,
            );
          };
          reader.readAsDataURL(input.files[0]);
        }
      }

      function loadBulletinData() {
        if (
          !confirm(
            "This will overwrite current editor content with generated bulletin data. Continue?",
          )
        )
          return;

        clearWorkspace();

        // 1. Prepare Data
        const storedDate = localStorage.getItem("bihar_forecast_date");
        const dateObj = storedDate ? new Date(storedDate) : new Date();

        const day = String(dateObj.getDate()).padStart(2, "0");
        const month = String(dateObj.getMonth() + 1).padStart(2, "0");
        const year = dateObj.getFullYear();
        const dateStr = `${day}.${month}.${year}`;

        // Time
        const now = new Date();
        let h = now.getHours();
        let m = now.getMinutes();
        // Round logic similar to Generate_Weather_Bulletin
        const remainder = m % 15;
        if (remainder >= 8) m += 15 - remainder;
        else m -= remainder;
        if (m === 60) {
          m = 0;
          h += 1;
        }
        const timeStr = `${String(h).padStart(2, "0")}:${String(m).padStart(2, "0")}`;

        // Header HTML
        const headerHTML = `
            <div class="header-top">
                <div class="logo-container"><img src="assets/logo.png" class="logo" onerror="this.style.display='none'"></div>
                <div class="header-text">
                    <div> </div>
                    <div>  </div>
                    <div>   </div>
                    <div>  , </div>
                    <div>  800002</div>
                    <div style="font-weight: normal; font-size: 12px">Website: https://mausam.imd.gov.in/patna | -: mc.patna@imd.gov.in</div>
                </div>
                <div class="logo-container"><img src="assets/IMD_150_Year_Logo.png" class="logo" onerror="this.style.display='none'"></div>
            </div>
            <div class="season-title">- / POST-MONSOON SEASON</div>
            <div class="date-time-row">
                <div>DATE: ${dateStr}</div>
                <div>TIME OF ISSUE: ${timeStr} HRS IST</div>
            </div>
        `;

        // Content Parts
        const summary =
          localStorage.getItem("bihar_generated_summary") ||
          "<p>No Summary Generated.</p>";
        const forecastTable =
          localStorage.getItem("bihar_detailed_forecast_html") ||
          "<p>No Detailed Forecast Table.</p>";
        const warningTable =
          localStorage.getItem("bihar_warning_table_html") ||
          "<p>No Warning Table.</p>";
        const tempTable =
          localStorage.getItem("bihar_temp_forecast_table_html") ||
          "<p>No Temp Forecast Table.</p>";

        // Images
        const minImg = localStorage.getItem("bihar_min_temp_forecast_image");
        const maxImg = localStorage.getItem("bihar_max_temp_forecast_image");
        const fcImg = localStorage.getItem("bihar_forecast_image");
        const warnImg = localStorage.getItem("bihar_warning_image");

        // Footer Data
        const dutyOfficer =
          localStorage.getItem("bihar_selected_duty_officer") || "Duty Officer";
        const issuedOfficer =
          localStorage.getItem("bihar_selected_issued_officer") || "Issued By";

        const footerHTML = `
            <table class="table-impact">
              <thead>
                <tr><th colspan="2">     /  (Expected Impact & Action Suggested)</th></tr>
                <tr><th class="col-impact"> (Impact)</th><th class="col-suggestion"> (Action Suggested)</th></tr>
              </thead>
              <tbody>
                <tr>
                  <td class="col-impact"><ul><li>      </li><li>  </li></ul></td>
                  <td class="col-suggestion"><ul><li>     </li><li>   </li></ul></td>
                </tr>
              </tbody>
            </table>
            <table class="table-terminology">
              <thead><tr><th colspan="4">    / Terminology used in forecast</th></tr></thead>
              <tbody>
                <tr><th colspan="2">  </th><th colspan="2"> </th></tr>
                <tr><td class="rain-ws">Widespread (WS)</td><td>76-100%</td><td class="warn-red">Red (Warning)</td><td>Take Action</td></tr>
                <tr><td class="rain-fws">Fairly Widespread (FWS)</td><td>51-75%</td><td class="warn-orange">Orange (Alert)</td><td>Be Prepared</td></tr>
                <tr><td class="rain-sct">Scattered (SCT)</td><td>26-50%</td><td class="warn-yellow">Yellow (Watch)</td><td>Be Updated</td></tr>
                <tr><td class="rain-isol">Isolated (ISOL)</td><td>1-25%</td><td class="warn-green">Green (No Warning)</td><td>No Action</td></tr>
                <tr><td class="rain-dry">Dry</td><td>0%</td><td colspan="2"></td></tr>
              </tbody>
            </table>
            <div class="signature-section">
              <div class="sig-box"><div class="sig-label">Duty Officer</div><div class="sig-line">${dutyOfficer}</div></div>
              <div class="sig-box"><div class="sig-label">Forecast Issued By</div><div class="sig-line">${issuedOfficer}</div></div>
            </div>
            <div style="text-align:center; font-size:10px; margin-top:20px;">Generated by SWFC Web Application</div>
        `;

        // --- Page Construction ---

        // Page 1: Header + Summary + Observed Table (usually in summary)
        addPage(headerHTML + summary);

        // Page 2: Detailed Forecast Table
        addPage(
          `<h3 style="text-align:center;">District Wise Detailed Weather Forecast</h3>` +
            forecastTable,
        );

        // Page 3: Warning Table + Temp Table (if fits, else split)
        // We'll put them on separate pages to be safe or same page if user wants "compact"
        // User asked for "with page break ke", implying separation.
        addPage(warningTable);
        addPage(tempTable);

        // Page 4: Min Temp Map
        if (minImg) {
          addPage(
            `<h3 style="text-align:center;">Minimum Temperature Forecast</h3><img src="${minImg}" style="width:100%; border:1px solid #ccc;">`,
          );
        } else {
          addPage(
            `<h3 style="text-align:center;">Minimum Temperature Forecast</h3><p style="text-align:center; padding:50px; border:2px dashed #ccc;">No Image Synced. Use Upload Panel.</p>`,
          );
        }

        // Page 5: Max Temp Map
        if (maxImg) {
          addPage(
            `<h3 style="text-align:center;">Maximum Temperature Forecast</h3><img src="${maxImg}" style="width:100%; border:1px solid #ccc;">`,
          );
        } else {
          addPage(
            `<h3 style="text-align:center;">Maximum Temperature Forecast</h3><p style="text-align:center; padding:50px; border:2px dashed #ccc;">No Image Synced. Use Upload Panel.</p>`,
          );
        }

        // Page 6: Forecast Map
        if (fcImg) {
          addPage(
            `<h3 style="text-align:center;">7-Day Forecast Map</h3><img src="${fcImg}" style="width:100%; border:1px solid #ccc;">`,
          );
        } else {
          addPage(
            `<h3 style="text-align:center;">7-Day Forecast Map</h3><p style="text-align:center; padding:50px; border:2px dashed #ccc;">No Image Synced. Use Upload Panel.</p>`,
          );
        }

        // Page 7: Warning Map
        if (warnImg) {
          addPage(
            `<h3 style="text-align:center;">7-Day Warning Map</h3><img src="${warnImg}" style="width:100%; border:1px solid #ccc;">`,
          );
        } else {
          addPage(
            `<h3 style="text-align:center;">7-Day Warning Map</h3><p style="text-align:center; padding:50px; border:2px dashed #ccc;">No Image Synced. Use Upload Panel.</p>`,
          );
        }

        // Page 8: Footer
        addPage(footerHTML);

        // Clean up first page header (remove default "Header Section 1")
        const p1 = document.getElementById("page-1");
        if (p1) {
          const ph = p1.querySelector(".page-header");
          if (ph) ph.innerHTML = ""; // Clear running header on first page as it has official header
        }

        // Update Date Input
        const dateInput = document.getElementById("manualDateInput");
        if (dateInput) {
          const yyyy = dateObj.getFullYear();
          const mm = String(dateObj.getMonth() + 1).padStart(2, "0");
          const dd = String(dateObj.getDate()).padStart(2, "0");
          dateInput.value = `${yyyy}-${mm}-${dd}`;
        }

        alert("Bulletin Data Loaded Successfully!");
      }
    </script>
  </body>
</html>
